<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libpcp: KEYEXPORT</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libpcp
   &#160;<span id="projectnumber">0.2.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">KEYEXPORT</div>  </div>
</div><!--header-->
<div class="contents">

<p>Functions to export and import keys in various formats.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga297bca6f73e413db21c5fb1095fc51d5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__PubKeyExport.html#ga297bca6f73e413db21c5fb1095fc51d5">pcp_export_rfc_pub</a> (<a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *sk)</td></tr>
<tr class="memdesc:ga297bca6f73e413db21c5fb1095fc51d5"><td class="mdescLeft">&#160;</td><td class="mdescRight">RFC4880 alike public key export with some modifications.  <a href="#ga297bca6f73e413db21c5fb1095fc51d5"></a><br/></td></tr>
<tr class="separator:ga297bca6f73e413db21c5fb1095fc51d5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gabfb1403cf523240b3b3192a9611b0e84"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__PubKeyExport.html#gabfb1403cf523240b3b3192a9611b0e84">pcp_export_pbp_pub</a> (<a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *sk)</td></tr>
<tr class="memdesc:gabfb1403cf523240b3b3192a9611b0e84"><td class="mdescLeft">&#160;</td><td class="mdescRight">Export a public key in PBP format.  <a href="#gabfb1403cf523240b3b3192a9611b0e84"></a><br/></td></tr>
<tr class="separator:gabfb1403cf523240b3b3192a9611b0e84"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga12c5a4abb2ee4a39468a0bce40e1803e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__PubKeyExport.html#ga12c5a4abb2ee4a39468a0bce40e1803e">pcp_export_yaml_pub</a> (<a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *sk)</td></tr>
<tr class="memdesc:ga12c5a4abb2ee4a39468a0bce40e1803e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Export a public key in yaml format.  <a href="#ga12c5a4abb2ee4a39468a0bce40e1803e"></a><br/></td></tr>
<tr class="separator:ga12c5a4abb2ee4a39468a0bce40e1803e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga76abbe52369932afe6b929ddebabb3a5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__PubKeyExport.html#ga76abbe52369932afe6b929ddebabb3a5">pcp_export_perl_pub</a> (<a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *sk)</td></tr>
<tr class="memdesc:ga76abbe52369932afe6b929ddebabb3a5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Export a public key in perl code format.  <a href="#ga76abbe52369932afe6b929ddebabb3a5"></a><br/></td></tr>
<tr class="separator:ga76abbe52369932afe6b929ddebabb3a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga10025040f3c5c93644aab02673346723"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__PubKeyExport.html#ga10025040f3c5c93644aab02673346723">pcp_export_c_pub</a> (<a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *sk)</td></tr>
<tr class="memdesc:ga10025040f3c5c93644aab02673346723"><td class="mdescLeft">&#160;</td><td class="mdescRight">Export a public key in C code format.  <a href="#ga10025040f3c5c93644aab02673346723"></a><br/></td></tr>
<tr class="separator:ga10025040f3c5c93644aab02673346723"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae702b541366d32ae73e76e4810928bd9"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__PubKeyExport.html#gae702b541366d32ae73e76e4810928bd9">pcp_export_secret</a> (<a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *sk, char *passphrase)</td></tr>
<tr class="memdesc:gae702b541366d32ae73e76e4810928bd9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Export secret key.  <a href="#gae702b541366d32ae73e76e4810928bd9"></a><br/></td></tr>
<tr class="separator:gae702b541366d32ae73e76e4810928bd9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Functions to export and import keys in various formats. </p>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ga10025040f3c5c93644aab02673346723"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a>* pcp_export_c_pub </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *&#160;</td>
          <td class="paramname"><em>sk</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Export a public key in C code format. </p>
<p>Export a public key in C code format.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sk</td><td>a secret key structure of type pcp_key_t. The secret keys in there have to be already decrypted.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the function returns a Buffer object containing the binary blob containing a C code string. </dd></dl>

</div>
</div>
<a class="anchor" id="gabfb1403cf523240b3b3192a9611b0e84"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a>* pcp_export_pbp_pub </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *&#160;</td>
          <td class="paramname"><em>sk</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Export a public key in PBP format. </p>
<p>Export a public key in the format described at <a href="https://github.com/stef/pbp/blob/master/doc/fileformats.txt">https://github.com/stef/pbp/blob/master/doc/fileformats.txt</a></p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sk</td><td>a secret key structure of type pcp_key_t. The secret keys in there have to be already decrypted.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the function returns a Buffer object containing the binary blob in the format described above. </dd></dl>

</div>
</div>
<a class="anchor" id="ga76abbe52369932afe6b929ddebabb3a5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a>* pcp_export_perl_pub </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *&#160;</td>
          <td class="paramname"><em>sk</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Export a public key in perl code format. </p>
<p>Export a public key in perl code format.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sk</td><td>a secret key structure of type pcp_key_t. The secret keys in there have to be already decrypted.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the function returns a Buffer object containing the binary blob containing a perl code string (a hash definition). </dd></dl>

</div>
</div>
<a class="anchor" id="ga297bca6f73e413db21c5fb1095fc51d5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a>* pcp_export_rfc_pub </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *&#160;</td>
          <td class="paramname"><em>sk</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>RFC4880 alike public key export with some modifications. </p>
<p>RFC4880 alike public key export with the following modifications:</p>
<ul>
<li>Key material is native to us and not specified in the rfc for curve25519/ed25519. Therefore we're doing it like so: mp|sp|cp where mp = master keysigning public key (ed25519), 32 bytes sp = signing public key (ed25519), 32 bytes cp = encryption public key (curve25519), 32 bytes</li>
</ul>
<ul>
<li>The various cipher (algorithm) id's are unspecified for our native ciphers. Therefore I created them, starting at 33 (afaik 22 is the last officially assigned one). Once those cipher numbers become official, I'll use them instead of my own.</li>
</ul>
<ul>
<li>The exported public key packet contains a signature. We're filling out all required fields. A signature has a variable number of sig sub packets. We use only these types: <pre class="fragment">   2 = Signature Creation Time     (4 byte)
   3 = Signature Expiration Time   (4 byte)
   9 = Key Expiration Time         (4 bytes)
  20 = Notation Data               (4 byte flags, N bytes name+value)
  27 = Key Flags                   (1 byte, use 0x02, 0x08 and 0x80
</pre></li>
</ul>
<ul>
<li>We use 3 notation fields: "owner", which contains the owner name, if set "mail", which contains the emailaddress, if set "serial", which contains the 32bit serial number</li>
</ul>
<ul>
<li>The actual signature field consists of the blake2 hash of (mp|sp|cp|keysig) followed by the nacl signature. However, we do not put an extra 16byte value of the hash, since the nacl signature already contains the full hash. So, an implementation could simply pull the fist 16 bytes of said hash to get the same result.</li>
</ul>
<ul>
<li>The mp keypair will be used for signing. The recipient can verify the signature, since mp is included.</li>
</ul>
<ul>
<li>While we put expiration dates for the key and the signature into the export as the rfc demands, we ignore them. Key expiring is not implemented in PCP yet.</li>
</ul>
<p>So, a full pubkey export looks like this </p>
<pre class="fragment">   version
   ctime
   cipher
   3 x raw keys            \
   sigheader                &gt; calc hash from this
     sigsubs (header+data) /
   hash
   signature
</pre><p>We use big-endian always.</p>
<p>Unlike RC4880 public key exports, we're using Z85 encoding if armoring have been requested by the user. Armored output has a header and a footer line, however they are ignored by the parser and are therefore optional. Newlines, if present, are optional as well.</p>
<p><a href="http://tools.ietf.org/html/rfc4880#section-5.2.3">http://tools.ietf.org/html/rfc4880#section-5.2.3</a></p>
<p>The key sig blob will be saved in the Vault if we import a public key unaltered, so we can verify the signature at will anytime. When exporting a foreign public key, we will just put out that key sig blob to the export untouched.</p>
<p>Currently PCP only support self-signed public key exports.</p>
<p>We only support one key signature per key. However, it would be easily possible to support foreign keysigs as well in the future.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sk</td><td>a secret key structure of type pcp_key_t. The secret keys in there have to be already decrypted.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the function returns a Buffer object containing the binary blob in the format described above. </dd></dl>

</div>
</div>
<a class="anchor" id="gae702b541366d32ae73e76e4810928bd9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a>* pcp_export_secret </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *&#160;</td>
          <td class="paramname"><em>sk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>passphrase</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Export secret key. </p>
<p>Export a secret key.</p>
<p>Secret key are exported in proprietary format.</p>
<p>The exported binary blob is symmetrically encrypted using the NACL function crypto_secret(). The passphrase will be used to derive an encryption key using the STAR function scrypt().</p>
<p>The binary data before encryption consists of:</p>
<ul>
<li>ED25519 master signing secret</li>
<li>Curve25519 encryption secret</li>
<li>ED25519 signing secret</li>
<li>ED25519 master signing public</li>
<li>Curve25519 encryption public</li>
<li>ED25519 signing public</li>
<li>Optional notations, currently supported are the 'owner' and 'mail' attributes. If an attribute is empty, the len field contains zero.<ol type="1">
<li>len(VAL) (2 byte uint)</li>
<li>VAL (string without trailing zero)</li>
</ol>
</li>
<li>8 byte creation time (epoch)</li>
<li>4 byte key version</li>
<li>4 byte serial number</li>
</ul>
<p>The encrypted cipher will be prepended with the random nonce used to encrypt the data and looks after encryption as such:</p>
<p>Nonce | Cipher</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sk</td><td>a secret key structure of type pcp_key_t. The secret keys in there have to be already decrypted.</td></tr>
    <tr><td class="paramname">passphrase</td><td>the passphrase to be used to encrypt the export, a null terminated char array.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the function returns a Buffer object containing the binary blob in the format described above. </dd></dl>

</div>
</div>
<a class="anchor" id="ga12c5a4abb2ee4a39468a0bce40e1803e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__Buffer.html#ga2460ea15a51a37433b5f2e1503667e8f">Buffer</a>* pcp_export_yaml_pub </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__KEYS.html#gae88eb39995125f3b68b4ce9175b41732">pcp_key_t</a> *&#160;</td>
          <td class="paramname"><em>sk</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Export a public key in yaml format. </p>
<p>Export a public key in yaml format.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sk</td><td>a secret key structure of type pcp_key_t. The secret keys in there have to be already decrypted.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the function returns a Buffer object containing the binary blob containing a YAML string. </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Feb 20 2014 19:59:14 for libpcp by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
